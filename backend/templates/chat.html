<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ specialist_name }} - Arogyam.ai</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">
                <span class="logo-icon">üè•</span>
                <span class="logo-text">Arogyam.ai</span>
            </a>
            <div class="nav-links">
                <a href="/">Home</a>
                <a href="/specialists">Specialists</a>
                <a href="#" class="active">Chat</a>
            </div>
        </div>
    </nav>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="specialist-info">
                <div class="specialist-avatar">{{ specialist_icon }}</div>
                <h2>{{ specialist_name }}</h2>
                <p class="specialist-desc">{{ specialist_description }}</p>
            </div>

            <div class="upload-section">
                <h3>üì§ Upload Files</h3>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.dcm" multiple hidden>
                    <label for="fileInput" class="upload-label">
                        <span class="upload-icon">üìÅ</span>
                        <span>Click to upload</span>
                        <span class="upload-hint">PDF, Images, DICOM</span>
                    </label>
                </div>
                <div id="fileList" class="file-list"></div>
            </div>

            <div class="info-box">
                <h4>üí° Tips</h4>
                <ul>
                    <li>Describe your symptoms clearly</li>
                    <li>Upload relevant medical reports</li>
                    <li>Ask specific questions</li>
                    <li>Mention duration of symptoms</li>
                </ul>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="header-info">
                    <span class="specialist-avatar-small">{{ specialist_icon }}</span>
                    <div>
                        <h3>{{ specialist_name }}</h3>
                        <span class="status">üü¢ Online</span>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    <div class="message-avatar">{{ specialist_icon }}</div>
                    <div class="message-content">
                        <p>Hello! I'm your AI {{ specialist_name }}. How can I assist you today?</p>
                        <span class="message-time">Just now</span>
                    </div>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type your message here..." 
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button">
                        <span>Send</span>
                        <span class="send-icon">üì§</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        <p>‚ö†Ô∏è This is an AI assistant providing preliminary insights. Always consult with qualified healthcare professionals for medical decisions.</p>
    </div>

    <script>
        // Get specialist type from URL
        const specialistType = "{{ specialist_type }}";
        
        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const fileList = document.getElementById('fileList');
        const uploadedFiles = [];

        fileInput.addEventListener('change', handleFileSelect);

        async function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                if (file.size <= 16 * 1024 * 1024) { // 16MB limit
                    try {
                        // Upload file to server
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            uploadedFiles.push(data.filename);
                            addFileToList(data.filename);
                        } else {
                            alert(`Failed to upload ${file.name}: ${data.error}`);
                        }
                    } catch (error) {
                        alert(`Error uploading ${file.name}: ${error.message}`);
                    }
                } else {
                    alert(`${file.name} is too large. Maximum size is 16MB.`);
                }
            }
            fileInput.value = '';
        }

        function addFileToList(fileName) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-icon">üìÑ</span>
                <span class="file-name">${fileName}</span>
                <button class="remove-file" onclick="removeFile('${fileName}')">‚úï</button>
            `;
            fileList.appendChild(fileItem);
        }

        function removeFile(fileName) {
            const index = uploadedFiles.findIndex(f => f === fileName);
            if (index > -1) {
                uploadedFiles.splice(index, 1);
                const fileItems = fileList.getElementsByClassName('file-item');
                for (let item of fileItems) {
                    if (item.querySelector('.file-name').textContent === fileName) {
                        item.remove();
                        break;
                    }
                }
            }
        }

        // Chat functionality
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Send message on Enter (Shift+Enter for new line)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Disable send button
            sendButton.disabled = true;

            // Add user message to chat
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Show typing indicator
            showTypingIndicator();

            try {
                // Send to backend
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        specialist: specialistType,
                        files: uploadedFiles
                    })
                });

                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();

                // Add bot response
                if (data.success) {
                    addMessage(data.response, 'bot');
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
            } catch (error) {
                removeTypingIndicator();
                addMessage('Sorry, I encountered an error connecting to the server. Please try again.', 'bot');
                console.error('Error:', error);
            } finally {
                // Re-enable send button
                sendButton.disabled = false;
            }
        }

        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            // Convert markdown-style bold to HTML
            const formattedText = text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            if (type === 'bot') {
                messageDiv.innerHTML = `
                    <div class="message-avatar">{{ specialist_icon }}</div>
                    <div class="message-content">
                        <p>${formattedText}</p>
                        <span class="message-time">${time}</span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${formattedText}</p>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-avatar">üë§</div>
                `;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">{{ specialist_icon }}</div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }
    </script>
</body>
</html>